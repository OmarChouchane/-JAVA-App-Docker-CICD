name: Task Flow Pipeline

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
env:
    APP_NAME: task-flows-app

jobs:
    tests:
        env:
            TZ: europe/berlin
        runs-on: ubuntu-latest
        name: Tests
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup JDK
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "corretto"

            - name: Cache Maven dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

            - name: Running Unit Tests
              run: |
                  ./mvnw clean test

    build-and-deploy:
        needs: tests
        runs-on: ubuntu-latest
        name: Build & Deploy
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup JDK
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "corretto"

            - name: Cache Maven dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

            - name: Extract project version
              id: extract_version
              run: |
                  VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
            - name: Build Application
              run: ./mvnw clean package -DskipTests

            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to DockerHub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and Push Docker Image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: |
                      ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest
                      ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:${{ steps.extract_version.outputs.VERSION }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      PROFILE=dev

            - name: Deploy to Server
              uses: appleboy/ssh-action@v0.1.7
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_SSH_PORT }}
                  script: |
                      # Navigate to app directory
                      cd /opt/${{ env.APP_NAME }} || mkdir -p /opt/${{ env.APP_NAME }} && cd /opt/${{ env.APP_NAME }}

                      # Create .env file from secrets
                      cat > .env << EOF
                      DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
                      APP_NAME=${{ env.APP_NAME }}
                      DB_URL=postgres-sql-spring-app
                      PG_DB_USERNAME=${{ secrets.PG_DB_USERNAME }}
                      PG_DB_PASSWORD=${{ secrets.PG_DB_PASSWORD }}
                      PG_DB_DB_NAME=${{ secrets.PG_DB_DB_NAME }}  
                      EOF

                      # Download latest docker-compose.dev.yml from repository
                      curl -H "authorization:token ${{ secrets.GITHUB_TOKEN }}" -o docker-compose.dev.yml https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/main/docker-compose.dev.yml

                      # Pull the latest image
                      docker-compose -f docker-compose.dev.yml --env-file .env pull

                      # Stop and remove existing containers
                      docker-compose -f docker-compose.dev.yml --env-file .env down

                      # Start new containers
                      docker-compose -f docker-compose.dev.yml --env-file .env up -d

                      # Clean up old images
                      docker image prune -f
